{% extends "base.html" %}

{% block title %}{{ city }} ‚Ä¢ CityNerve Lite{% endblock %}

{% block styles %}
  <style>
    /* keep view_enhanced visual tokens */
    :root{--primary:#8b5cf6;--primary-light:#a78bfa;--text-primary:#e0e7ff;--text-secondary:#94a3b8}
    .preloader{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#0a0e27 0%,#1a1f3a 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
    .loader{width:60px;height:60px;border:2px solid rgba(139,92,246,0.2);border-top:2px solid #8b5cf6;border-radius:50%;animation:spin 1.5s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .bg-elements{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1;pointer-events:none}
    .neural-grid{position:absolute;width:100%;height:100%;background:linear-gradient(90deg,rgba(139,92,246,0.03) 1px,transparent 1px),linear-gradient(rgba(139,92,246,0.03) 1px,transparent 1px);background-size:40px 40px}
    .particles{position:absolute;width:100%;height:100%}
    .particle{position:absolute;width:3px;height:3px;border-radius:50%;box-shadow:0 0 10px rgba(139,92,246,0.5)}
    .container-2080{position:relative;z-index:10;max-width:900px;margin:0 auto;padding:60px 20px}
    .city-name{font-size:56px;font-weight:800;margin-bottom:16px; background:linear-gradient(135deg,#a78bfa,#60a5fa,#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .aqi-section{background:rgba(30,41,59,0.6);border:1px solid rgba(139,92,246,0.2);border-radius:16px;padding:16px;display:inline-block}
    .score-card{background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(96,165,250,0.1));border-radius:24px;padding:36px;text-align:center;margin-top:24px}
    .parameters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;margin-top:24px}
    .parameter-card{background:rgba(30,41,59,0.65);border-radius:18px;padding:20px}
    .action-buttons{display:flex;gap:12px;justify-content:center;margin-top:30px}
    #cityMap{width:100%;height:320px;border-radius:12px;margin-bottom:18px}
  </style>
{% endblock %}

{% block content %}
  <div class="preloader" id="preloader"><div class="loader"></div></div>

  <div class="bg-elements">
    <div class="neural-grid"></div>
    <div class="particles" id="particles"></div>
  </div>

  <div class="container-2080">
    <div class="header-section text-center">
      <h1 class="city-name">{{ city }}</h1>

      <div id="cityMap" aria-hidden="false"></div>

      <div class="aqi-section mt-3">
        <div class="aqi-label">Real-Time Air Quality Index</div>
        <div class="aqi-value">{% if pol.aqi is not none %}{{ pol.aqi }}{% else %}‚Äî{% endif %}</div>
        <div class="aqi-source">source: {{ pol.source }}{% if pol.stale %} ‚Ä¢ stale data{% endif %}</div>
      </div>
    </div>

    <div class="score-card">
      <div class="score-label">AI Liveability Score</div>
      <div class="score-value display-1 fw-bold">{{ score }}</div>
      <div class="score-subtitle">Comprehensive urban liveability index powered by adaptive AI</div>
    </div>

    <div class="parameters-section">
      <h2 class="section-title">üìä City Parameters</h2>
      <div class="parameters-grid">
        {% for key, val in features.items() %}
          <div class="parameter-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>{{ key|capitalize }}</strong>
              <span>{{ val }}/10</span>
            </div>
            <div class="progress" style="height:12px">
              <div class="progress-bar bg-gradient" role="progressbar" style="width:{{ val*10 }}%" aria-valuenow="{{ val*10 }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="action-buttons">
      <a href="/feedback/{{ city }}" class="btn btn-primary">‚≠ê Give Feedback</a>
      <a href="/" class="btn btn-outline-light">‚Üê Back to Map</a>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    // Remove preloader after load
    window.addEventListener('load', ()=>{const p=document.getElementById('preloader'); if(p) p.style.display='none'});

    // create subtle particles
    (function createParticles(){
      const container=document.getElementById('particles');
      const colors=['#8b5cf6','#60a5fa','#34d399','#fbbf24'];
      if(!container) return;
      for(let i=0;i<20;i++){const el=document.createElement('div');el.className='particle';const x=Math.random()*window.innerWidth;const y=Math.random()*window.innerHeight;const size=Math.random()*3+1;el.style.left=x+'px';el.style.top=y+'px';el.style.width=size+'px';el.style.height=size+'px';el.style.background=colors[Math.floor(Math.random()*colors.length)];el.style.opacity=0.9;container.appendChild(el)}
    })();

    // Leaflet: geocode city name using Nominatim and place a red marker
    (function initCityMap(){
      const cityName = {{ city|tojson }};
      const mapEl = document.getElementById('cityMap');
      if(!mapEl || !cityName) return;
      const map = L.map(mapEl, {scrollWheelZoom:false}).setView([20.5937,78.9629],5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);

      // red marker icon
      const redIcon = new L.Icon({iconUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x-red.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',shadowSize:[41,41]});

      // Nominatim search with fallbacks (Photon) to improve reliability
      function placeMarker(lat, lon){
        try{map.setView([lat,lon],13); const marker=L.marker([lat,lon],{icon:redIcon}).addTo(map).bindPopup(cityName).openPopup(); map.invalidateSize();}catch(e){console.warn('placeMarker error',e)}
      }

      function tryPhoton(q){
        return fetch('https://photon.komoot.io/api/?q='+encodeURIComponent(q))
          .then(r=>r.json())
          .then(j=>{
            if(j && j.features && j.features.length){
              const f=j.features[0];
              const lon=f.geometry.coordinates[0], lat=f.geometry.coordinates[1];
              return {lat:lat, lon:lon};
            }
            return null;
          }).catch(()=>null);
      }

      fetch('https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q='+encodeURIComponent(cityName))
        .then(r=>r.json())
        .then(async results=>{
          if(results && results.length){
            const best = results[0];
            const lat = parseFloat(best.lat), lon = parseFloat(best.lon);
            placeMarker(lat, lon);
            return;
          }

          // try photon as a fallback
          const ph = await tryPhoton(cityName);
          if(ph){ placeMarker(ph.lat, ph.lon); return; }

          // final fallback: show country-level view
          map.setView([20.5937,78.9629],5);
        }).catch(async ()=>{
          const ph = await tryPhoton(cityName);
          if(ph){ placeMarker(ph.lat, ph.lon); return; }
          map.setView([20.5937,78.9629],5);
        });
    })();
  </script>
{% endblock %}
 
