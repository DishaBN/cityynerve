<!DOCTYPE html>
<html>
<head>
  <title>{{ city }} ‚Ä¢ AI Analysis 2080</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="dark">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #8b5cf6;
      --primary-light: #a78bfa;
      --secondary: #60a5fa;
      --accent: #34d399;
      --danger: #ef4444;
      --text-primary: #e0e7ff;
      --text-secondary: #94a3b8;
      --glow: rgba(139, 92, 246, 0.5);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1729 100%);
      color: var(--text-primary);
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* Preloader */
    .preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeOut 0.8s ease-out 0.8s forwards;
    }

    .loader {
      width: 60px;
      height: 60px;
      border: 2px solid rgba(139, 92, 246, 0.2);
      border-top: 2px solid #8b5cf6;
      border-radius: 50%;
      animation: spin 1.5s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        visibility: hidden;
      }
    }

    /* Background */
    .bg-elements {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
    }

    .neural-grid {
      position: absolute;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(90deg, rgba(139, 92, 246, 0.03) 1px, transparent 1px),
        linear-gradient(rgba(139, 92, 246, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    .particles {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: radial-gradient(circle, #8b5cf6, rgba(139, 92, 246, 0.1));
      border-radius: 50%;
      animation: float linear infinite;
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
    }

    @keyframes float {
      to {
        transform: translateY(-100vh) translateX(var(--tx));
        opacity: 0;
      }
    }

    /* Main Content */
    .container-2080 {
      position: relative;
      z-index: 10;
      max-width: 900px;
      margin: 0 auto;
      padding: 60px 20px;
    }

    .header-section {
      margin-bottom: 60px;
      animation: slideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .city-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #a78bfa;
      text-decoration: none;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .back-btn:hover {
      color: #c4b5fd;
      transform: translateX(-4px);
    }

    .city-name {
      font-size: 56px;
      font-weight: 800;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #a78bfa, #60a5fa, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -1px;
    }

    .aqi-section {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(10px);
      display: inline-block;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(139, 92, 246, 0.15);
    }

    .aqi-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      font-weight: 700;
    }

    .aqi-value {
      font-size: 36px;
      font-weight: 800;
      color: #fbbf24;
      margin-bottom: 8px;
    }

    .aqi-source {
      font-size: 12px;
      color: #64748b;
    }

    /* Score Card */
    .score-card {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(96, 165, 250, 0.1));
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 24px;
      padding: 48px 40px;
      text-align: center;
      margin-bottom: 60px;
      backdrop-filter: blur(10px);
      box-shadow: 0 25px 70px rgba(139, 92, 246, 0.2);
      animation: slideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s both;
    }

    .score-label {
      font-size: 13px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .score-display {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 0 auto 30px;
    }

    .score-circle {
      position: absolute;
      width: 100%;
      height: 100%;
      transform: rotateZ(-90deg);
      filter: drop-shadow(0 0 35px rgba(139, 92, 246, 0.4));
    }

    .score-bg {
      fill: none;
      stroke: rgba(139, 92, 246, 0.1);
      stroke-width: 10;
    }

    .score-progress {
      fill: none;
      stroke: url(#scoreGradient);
      stroke-width: 10;
      stroke-linecap: round;
      stroke-dasharray: 565;
      stroke-dashoffset: 565;
      animation: scoreAnim 2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes scoreAnim {
      from {
        stroke-dashoffset: 565;
      }
      to {
        stroke-dashoffset: 0;
      }
    }

    .score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .score-value {
      font-size: 64px;
      font-weight: 800;
      color: #a78bfa;
    }

    .score-unit {
      font-size: 16px;
      color: #64748b;
      margin-top: 4px;
    }

    .score-subtitle {
      font-size: 16px;
      color: #cbd5e1;
      margin-top: 24px;
      font-weight: 500;
    }

    /* Parameters */
    .parameters-section {
      margin-bottom: 60px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 32px;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .parameters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }

    .parameter-card {
      background: rgba(30, 41, 59, 0.65);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 18px;
      padding: 28px;
      backdrop-filter: blur(10px);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
      overflow: hidden;
      position: relative;
    }

    .parameter-card:nth-child(1) { animation-delay: 0.1s; }
    .parameter-card:nth-child(2) { animation-delay: 0.2s; }
    .parameter-card:nth-child(3) { animation-delay: 0.3s; }
    .parameter-card:nth-child(4) { animation-delay: 0.4s; }
    .parameter-card:nth-child(5) { animation-delay: 0.5s; }
    .parameter-card:nth-child(6) { animation-delay: 0.6s; }
    .parameter-card:nth-child(7) { animation-delay: 0.7s; }
    .parameter-card:nth-child(8) { animation-delay: 0.8s; }
    .parameter-card:nth-child(9) { animation-delay: 0.9s; }

    .parameter-card:hover {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(96, 165, 250, 0.15));
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 15px 50px rgba(139, 92, 246, 0.3);
      transform: translateY(-6px);
    }

    .parameter-name {
      font-size: 14px;
      font-weight: 700;
      text-transform: capitalize;
      color: #cbd5e1;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      letter-spacing: 0.5px;
    }

    .parameter-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--primary-light);
      margin-bottom: 18px;
    }

    .progress-bar-container {
      height: 10px;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      margin-bottom: 14px;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 12px;
      background: linear-gradient(90deg, #8b5cf6, #60a5fa);
      width: 0%;
      animation: fillBar 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      position: relative;
      overflow: hidden;
    }

    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes fillBar {
      to {
        width: var(--percentage);
      }
    }

    @keyframes shimmer {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }

    .parameter-info {
      font-size: 12px;
      color: #64748b;
      display: flex;
      justify-content: space-between;
      font-weight: 500;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 16px;
      margin-top: 60px;
      justify-content: center;
      flex-wrap: wrap;
      animation: slideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.5s both;
    }

    .btn {
      padding: 15px 32px;
      border-radius: 14px;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #8b5cf6, #60a5fa);
      color: white;
      box-shadow: 0 12px 35px rgba(139, 92, 246, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 50px rgba(139, 92, 246, 0.5);
    }

    .btn-secondary {
      background: rgba(139, 92, 246, 0.1);
      color: #a78bfa;
      border: 1.5px solid rgba(139, 92, 246, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.5);
      transform: translateY(-4px);
    }

    /* Problem Reporting Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.show {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(30, 27, 59, 0.85));
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 28px;
      padding: 48px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 30px 90px rgba(0, 0, 0, 0.6);
      animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .modal-title {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, #a78bfa, #60a5fa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 28px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: var(--primary-light);
      transform: rotate(90deg);
    }

    .form-group {
      margin-bottom: 28px;
    }

    .form-label {
      display: block;
      font-weight: 700;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-textarea {
      width: 100%;
      padding: 16px;
      background: rgba(15, 23, 41, 0.7);
      border: 1.5px solid rgba(139, 92, 246, 0.2);
      border-radius: 14px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 120px;
      outline: none;
      transition: all 0.3s ease;
    }

    .form-textarea:focus {
      background: rgba(15, 23, 41, 0.95);
      border-color: var(--primary);
      box-shadow: 0 0 30px var(--glow);
    }

    /* Location Section */
    .location-section {
      background: rgba(139, 92, 246, 0.05);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 24px;
    }

    .location-status {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .location-status.ready {
      color: #34d399;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .location-map {
      width: 100%;
      height: 200px;
      border-radius: 10px;
      margin-top: 12px;
      display: none;
    }

    .location-map.show {
      display: block;
    }

    /* Image Upload */
    .upload-area {
      background: rgba(139, 92, 246, 0.08);
      border: 2px dashed rgba(139, 92, 246, 0.3);
      border-radius: 14px;
      padding: 28px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 24px;
    }

    .upload-area:hover, .upload-area.drag-over {
      background: rgba(139, 92, 246, 0.15);
      border-color: var(--primary);
      box-shadow: 0 0 25px rgba(139, 92, 246, 0.2);
    }

    .upload-icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    .upload-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .upload-hint {
      font-size: 12px;
      color: #64748b;
    }

    .image-preview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .image-item {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      aspect-ratio: 1;
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.2);
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: #ef4444;
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .image-item:hover .image-remove {
      opacity: 1;
    }

    /* Form Buttons */
    .form-buttons {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    .form-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 13px;
    }

    .form-btn-submit {
      background: linear-gradient(135deg, #8b5cf6, #60a5fa);
      color: white;
      box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
    }

    .form-btn-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(139, 92, 246, 0.5);
    }

    .form-btn-cancel {
      background: rgba(139, 92, 246, 0.1);
      color: #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .form-btn-cancel:hover {
      background: rgba(139, 92, 246, 0.2);
    }

    .form-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container-2080 {
        padding: 40px 16px;
      }

      .city-name {
        font-size: 40px;
      }

      .parameters-grid {
        grid-template-columns: 1fr;
      }

      .score-card {
        padding: 30px;
      }

      .modal-content {
        padding: 32px;
        border-radius: 20px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="preloader">
    <div class="loader"></div>
  </div>

  <div class="bg-elements">
    <div class="neural-grid"></div>
    <div class="particles" id="particles"></div>
  </div>

  <div class="container-2080">
    <div class="header-section">
      <a href="/" class="back-btn">‚Üê Back to Dashboard</a>

      <div class="city-header">
        <h1 class="city-name">{{ city }}</h1>

        <div class="aqi-section">
          <div class="aqi-label">Real-Time Air Quality Index</div>
          <div class="aqi-value">{% if pol.aqi is not none %}{{ pol.aqi }}{% else %}‚Äî{% endif %}</div>
          <div class="aqi-source">source: {{ pol.source }}{% if pol.stale %} ‚Ä¢ stale data{% endif %}</div>
        </div>
      </div>
    </div>

    <div class="score-card">
      <div class="score-label">AI Liveability Score</div>

      <div class="score-display">
        <svg class="score-circle" viewBox="0 0 200 200" width="200" height="200">
          <defs>
            <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#a78bfa"/>
              <stop offset="50%" stop-color="#60a5fa"/>
              <stop offset="100%" stop-color="#34d399"/>
            </linearGradient>
          </defs>
          <circle cx="100" cy="100" r="90" class="score-bg"/>
          <circle cx="100" cy="100" r="90" class="score-progress"/>
        </svg>
        <div class="score-text">
          <div class="score-value">{{ score }}</div>
          <div class="score-unit">/100</div>
        </div>
      </div>

      <div class="score-subtitle">Comprehensive urban liveability index powered by adaptive AI</div>
    </div>

    <div class="parameters-section">
      <h2 class="section-title">üìä City Parameters</h2>

      <div class="parameters-grid">
        {% for key, val in features.items() %}
          <div class="parameter-card">
            <div class="parameter-name">
              <span>{{ key|capitalize }}</span>
              <span>{{ val }}/10</span>
            </div>

            <div class="progress-bar-container">
              <div class="progress-bar-fill" style="--percentage: {{ val * 10 }}%"></div>
            </div>

            <div class="parameter-info">
              <span>Rating</span>
              <span>
                {% if val >= 8 %} ‚≠ê‚≠ê‚≠ê Excellent
                {% elif val >= 6 %} ‚≠ê‚≠ê Good
                {% elif val >= 4 %} ‚≠ê Fair
                {% else %} Needs Improvement {% endif %}
              </span>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="action-buttons">
      <a href="/feedback/{{ city }}" class="btn btn-primary">‚≠ê Give Feedback</a>
      <button class="btn btn-secondary" id="reportBtn">üö® Report Problem</button>
      <a href="/" class="btn btn-secondary">‚Üê Back to Map</a>
    </div>
  </div>

  <!-- Problem Reporting Modal -->
  <div class="modal-overlay" id="problemModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Report Issue</h2>
        <button class="modal-close" id="closeModal">‚úï</button>
      </div>

      <form id="reportForm">
        <div class="form-group">
          <label class="form-label">Describe the Problem</label>
          <textarea class="form-textarea" id="problemDescription" placeholder="Tell us what's wrong with this city..." required></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">üìç Location</label>
          <button type="button" class="btn btn-secondary" id="captureLocation" style="width: 100%; justify-content: center;">
            üìç Capture Current Location
          </button>
          <div class="location-section" id="locationSection" style="display: none;">
            <div class="location-status" id="locationStatus">
              <span class="status-dot"></span>
              <span id="locationText">Location captured</span>
            </div>
            <div class="location-map" id="locationMap"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Upload Images (Optional)</label>
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üì∏</div>
            <div class="upload-text">Drag & drop images here or click to select</div>
            <div class="upload-hint">Supports JPG, PNG, WebP (up to 5MB each)</div>
            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
          </div>
          <div class="image-preview" id="imagePreview"></div>
        </div>

        <div class="form-buttons">
          <button type="submit" class="form-btn form-btn-submit">Submit Report</button>
          <button type="button" class="form-btn form-btn-cancel" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const city = "{{ city }}";
    const modal = document.getElementById('problemModal');
    const reportBtn = document.getElementById('reportBtn');
    const closeModal = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const reportForm = document.getElementById('reportForm');
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const captureLocation = document.getElementById('captureLocation');
    const locationSection = document.getElementById('locationSection');
    const locationText = document.getElementById('locationText');
    const locationMapEl = document.getElementById('locationMap');
    const problemDescription = document.getElementById('problemDescription');

    let capturedLocation = null;
    let uploadedImages = [];
    let map = null;

    // Modal Management
    reportBtn.addEventListener('click', () => modal.classList.add('show'));
    closeModal.addEventListener('click', () => modal.classList.remove('show'));
    cancelBtn.addEventListener('click', () => modal.classList.remove('show'));
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('show');
    });

    // Location Capture
    captureLocation.addEventListener('click', (e) => {
      e.preventDefault();
      if (navigator.geolocation) {
        captureLocation.disabled = true;
        captureLocation.textContent = '‚è≥ Getting location...';

        navigator.geolocation.getCurrentPosition(
          (position) => {
            capturedLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy
            };

            locationText.textContent = `üìç ${capturedLocation.lat.toFixed(4)}, ${capturedLocation.lng.toFixed(4)} (¬±${Math.round(capturedLocation.accuracy)}m)`;
            locationSection.style.display = 'block';
            locationMapEl.classList.add('show');
            captureLocation.textContent = '‚úì Location Updated';
            captureLocation.disabled = false;

            // Initialize map
            if (!map) {
              map = L.map('locationMap').setView([capturedLocation.lat, capturedLocation.lng], 15);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
              }).addTo(map);
            } else {
              map.setView([capturedLocation.lat, capturedLocation.lng], 15);
              // Remove old marker
              map.eachLayer((layer) => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
              });
            }

            // Add marker
            L.circleMarker([capturedLocation.lat, capturedLocation.lng], {
              radius: 8,
              fillColor: '#8b5cf6',
              color: '#a78bfa',
              weight: 2,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(map).bindPopup('Current Location').openPopup();

            // Add accuracy circle
            L.circle([capturedLocation.lat, capturedLocation.lng], capturedLocation.accuracy, {
              color: '#8b5cf6',
              fillColor: '#8b5cf6',
              fillOpacity: 0.1,
              weight: 1,
              dashArray: '5, 5'
            }).addTo(map);
          },
          (error) => {
            captureLocation.textContent = '‚úó Failed to get location';
            captureLocation.disabled = false;
            locationText.textContent = 'Could not access location. Please enable location services.';
          }
        );
      }
    });

    // Image Upload
    uploadArea.addEventListener('click', () => imageInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      handleImages(e.dataTransfer.files);
    });

    imageInput.addEventListener('change', (e) => {
      handleImages(e.target.files);
    });

    function handleImages(files) {
      for (let file of files) {
        if (file.type.startsWith('image/') && file.size <= 5242880) {
          const reader = new FileReader();
          reader.onload = (e) => {
            uploadedImages.push({
              name: file.name,
              data: e.target.result
            });
            displayImages();
          };
          reader.readAsDataURL(file);
        }
      }
    }

    function displayImages() {
      imagePreview.innerHTML = uploadedImages.map((img, idx) => `
        <div class="image-item">
          <img src="${img.data}" alt="Preview">
          <button type="button" class="image-remove" onclick="removeImage(${idx})">‚úï</button>
        </div>
      `).join('');
    }

    function removeImage(idx) {
      uploadedImages.splice(idx, 1);
      displayImages();
    }

    window.removeImage = removeImage;

    // Form Submission
    reportForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!problemDescription.value.trim()) {
        alert('Please describe the problem');
        return;
      }

      // Store report in localStorage
      const report = {
        city: city,
        description: problemDescription.value,
        location: capturedLocation,
        imageCount: uploadedImages.length,
        timestamp: new Date().toISOString()
      };

      const reports = JSON.parse(localStorage.getItem('reports') || '[]');
      reports.push(report);
      localStorage.setItem('reports', JSON.stringify(reports));

      // Show success
      alert(`‚úì Report submitted for ${city}. Thank you for helping improve urban intelligence!`);
      modal.classList.remove('show');
      reportForm.reset();
      uploadedImages = [];
      capturedLocation = null;
      displayImages();
      locationSection.style.display = 'none';
    });

    // Particles
    function createParticles() {
      const container = document.getElementById('particles');
      const colors = ['#8b5cf6', '#60a5fa', '#34d399', '#fbbf24'];
      
      for (let i = 0; i < 25; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        const x = Math.random() * window.innerWidth;
        const y = Math.random() * window.innerHeight;
        const size = Math.random() * 3 + 1;
        const duration = Math.random() * 20 + 20;
        const tx = (Math.random() - 0.5) * 100;
        
        particle.style.cssText = `
          left: ${x}px;
          top: ${y}px;
          width: ${size}px;
          height: ${size}px;
          --tx: ${tx}px;
          animation-duration: ${duration}s;
          animation-delay: ${Math.random() * 5}s;
          background: radial-gradient(circle, ${colors[Math.floor(Math.random() * colors.length)]}, rgba(139, 92, 246, 0.1));
        `;
        container.appendChild(particle);
      }
    }

    createParticles();

    // Set score circle progress
    const scoreValue = {{ score }};
    const scoreCircle = document.querySelector('.score-progress');
    if (scoreCircle) {
      const circumference = 565;
      const offset = circumference - ((scoreValue / 100) * circumference);
      scoreCircle.style.strokeDashoffset = offset;
      scoreCircle.style.animation = 'scoreAnim 2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';
    }
  </script>
</body>
</html>
